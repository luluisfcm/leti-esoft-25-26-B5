@startuml
'https://plantuml.com/sequence-diagram
autoactivate on
autonumber

actor "SNS User" as User
participant ":ScheduleVaccineView" as View
participant ":ScheduleVaccineController" as Ctrl
participant ":SNSUser" as SNSUser
participant "service:AppointmentService" as Service
participant "factory:RepositoryFactory" as Factory
participant "repo:VaccineTypeRepository" as VTRepo
participant "repo:VaccinationCenterRepository" as CenterRepo
participant "repo:AppointmentRepository" as AppRepo
participant "dto:ScheduleVaccineRequest" as Request
participant "dto:SchedulePreviewDTO" as Preview
participant "appt:Appointment" as Appointment

activate User

' --- STEP 1: User opens the scheduling feature ---
User -> View: requests to schedule vaccination
View -> Ctrl: requestScheduleVaccine()

Ctrl -> SNSUser: getAppointmentService()
SNSUser -> Factory: getVaccineTypeRepository()
Factory --> SNSUser: vtRepo
SNSUser -> Factory: getVaccinationCenterRepository()
Factory --> SNSUser: centerRepo
SNSUser -> Factory: getAppointmentRepository()
Factory --> SNSUser: appRepo
SNSUser --> Service**: create(vtRepo, centerRepo, appRepo)
SNSUser --> Ctrl: service

Ctrl -> Service: getInitialData()
Service -> VTRepo: getAll()
VTRepo --> Service: vaccineTypes
Service -> CenterRepo: getAll()
CenterRepo --> Service: centers
Service --> Ctrl: initialData(vaccineTypes, centers)
Ctrl --> View: showForm(initialData)
View --> User: form displayed

' --- STEP 2: User fills in the scheduling data ---
User -> View: inserts vaccineType, center,\n date, time, contactInfo
View -> Request: «create»(snsUserId, vaccineTypeId, centerId, date, time, contactInfo)
Request --> View: request
View -> Ctrl: submitScheduleData(request)

Ctrl -> Service: buildPreview(request)
Service -> VTRepo: getById(request.vaccineTypeId)
VTRepo --> Service: vaccineType
Service -> CenterRepo: getById(request.centerId)
CenterRepo --> Service: center
Service -> Preview: «create»(vaccineType, center, request.date, request.time)
Preview --> Service: preview
Service --> Ctrl: preview
Ctrl --> View: showPreview(preview)
View --> User: preview displayed

' --- STEP 3: User confirms the scheduling ---
User -> View: confirms scheduling
View -> Ctrl: confirmSchedule(request)
Ctrl -> Service: schedule(request)

' --- STEP 4: Business rule validation & appointment creation ---
Service -> AppRepo: findFutureByUserAndType(request.snsUserId, request.vaccineTypeId)
AppRepo --> Service: existingAppointments

Service -> AppRepo: isSlotAvailable(request.centerId, request.date, request.time)
AppRepo --> Service: slotAvailable

Service -> Appointment: «create»(request.date, request.time, Scheduled)
Appointment --> Service: appointment

alt valid data AND noConflict AND slotAvailable
    Service -> AppRepo: save(appointment)
    AppRepo --> Service: ok
    Service --> Ctrl: success(appointment)
    Ctrl --> View: showScheduleConfirmation(appointment)
    View --> User: confirmation shown
else invalid data OR conflict OR unavailable slot
    Service --> Ctrl: error(errorMessage)
    Ctrl --> View: showScheduleError(errorMessage)
    View --> User: error shown
end

@enduml